var shamanicWebApp=angular.module("shamanicWebApp",["mm.foundation","indexController","userControllers","gameController","menuControllers","utilitiesController","navigationController","ngRoute"]);shamanicWebApp.config(["$routeProvider","$httpProvider",function($routeProvider,$httpProvider){$httpProvider.defaults.headers.post["Content-Type"]="application/x-www-form-urlencoded",$httpProvider.defaults.transformRequest.unshift(function(data,headersGetter){var key,result=[];for(key in data)data.hasOwnProperty(key)&&("undefined"==typeof data[key]&&(data[key]=""),result.push(encodeURIComponent(key)+"="+encodeURIComponent(data[key])));return result.join("&")}),$routeProvider.when("/game/basecamp/:basecamp_icon",{templateUrl:"ui/js/views/basecamp.html",controller:"gameController"}).otherwise({redirectTo:"/"})}]);var gameController=angular.module("gameController",["gameAssetService","terraService","Sigil","Basecamp"]);gameController.controller("gameController",["$scope","$routeParams","gameAssetService","Sigil","Basecamp","terraService",function($scope,$routeParams,gameAssetService,Sigil,Basecamp,terraService){var ctrl=this;$scope.username=window.username,console.log("username from session: "+req.session.user.username),$scope.xAndyTracker=function(ev){$scope.X=ev.offsetX,$scope.Y=ev.offsetY},$scope.fireClick=function(event){$scope.X=event.offsetX,$scope.Y=event.offsetY,$scope.inOrOut=!0},$scope.zoomButtonClicked=function(){$scope.zoomEnabled=!$scope.zoomEnabled,console.log("clicked zoomButton, zoomEnabled: "+$scope.zoomEnabled)},$scope.terrafy=function(){terraService()},ctrl.sigilpack=new Sigil($scope.username),ctrl.sigilpack.getSigilsSimple().then(function(payload){$scope.restImageList=payload.data,console.log("from inside getSigilsSimple promise: "+JSON.stringify(payload.data)+" and scope.restImageList: "+JSON.stringify($scope.restImageList))},function(errPayload){console.log("failure communicating w gameAssetService API: "+errPayload)}),ctrl.sigilpack.getSigilsByUser().then(function(payload){$scope.userImageList=ctrl.sigilpack.properties,console.log("userImageList, just before basecamp obj call: "+JSON.stringify($scope.userImageList))},function(errPayload){console.log("failure getting user's sigilpack: "+errPayload.data)});var basecamp=new Basecamp($scope.username);basecamp.getBasecampSimple().then(function(){$scope.basecampObj=basecamp.properties,console.log(JSON.stringify($scope.basecampObj))}),$scope.basecamp_icon=$routeParams.basecamp_icon,console.log("basecamp_icon: "+$scope.basecamp_icon)}]);var indexController=angular.module("indexController",[]);indexController.controller("indexController",["$scope","$http",function($scope,$http){}]);var menuControllers=angular.module("menuControllers",[]);menuControllers.controller("menuController",["$scope","$http",function($scope,$http){}]);var userControllers=angular.module("userControllers",[]);userControllers.controller("loginController",["$scope","$http",function($scope,$http){$scope.showValidationMessages=!1,$scope.userNotFound=!1,$scope.submit=function(isFormValid){$scope.showValidationMessages=!0,isFormValid&&$http({url:"/user/checkLogin",method:"POST",data:{username:$scope.username,password:$scope.password}}).then(function(response){return $scope.userNotFound=!1,"user login sucessful"!=response.data?void($scope.userNotFound=!0):void(window.location="/user/account")},function(response){isFormValid=!1})}}]),userControllers.controller("signupController",["$scope","$http",function($scope,$http){$scope.showValidationMessages=!1,$scope.passwordMatch=!0,$scope.submit=function(isFormValid){if($scope.showValidationMessages=!0,$scope.passwordMatch=!0,$scope.password!=$scope.confirm&&($scope.passwordMatch=!1,isFormValid=!1),isFormValid){$scope.showEmailTakenError=!1,$scope.showUserTakenError=!1;var values={email:$scope.email,username:$scope.username};angular.forEach(values,function(value,key){$http({url:"/user/checkExistingValue",method:"POST",data:{property:key,value:value}}).then(function(response){"value exists"===response.data&&("email"==key?$scope.showEmailTakenError=!0:$scope.showUserTakenError=!0,isFormValid=!1),"username"===key&&isFormValid&&document.forms.signupform.submit()},function(response){isFormValid=!1})})}}}]),userControllers.controller("userAccountController",["$scope","$http",function($scope,$http){$scope.showAccountForm=!1,$scope.showValidationMessages=!1,$scope.fullname=window.fullname,$scope.showUpdateMessage=!1,$scope.updateMessage="",$scope.submit=function(isFormValid){$scope.showValidationMessages=!0,$scope.passwordMatch=!0,$scope.password!=$scope.confirm&&($scope.passwordMatch=!1,isFormValid=!1),isFormValid&&($scope.showUpdateMessage=!1,$scope.updateMessage="",$http({url:"/user/update",method:"POST",data:{fullname:$scope.fullname,password:$scope.password}}).then(function(response){$scope.showUpdateMessage=!0,$scope.updateMessage=response.data,$scope.showAccountForm=!1}))}}]),userControllers.controller("forgotController",["$scope","$http",function($scope,$http){$scope.showValidationMessages=!1,$scope.userNotFound=!1,$scope.passwordReset=!1,$scope.submit=function(isFormValid){$scope.showValidationMessages=!0,$scope.userNotFound=!1,"undefined"!=typeof $scope.username&&""!==$scope.username||"undefined"!=typeof $scope.email&&""!==$scope.email||($scope.userNotFound=!0,isFormValid=!1),isFormValid&&$http({url:"/user/checkForgot",method:"POST",data:{username:$scope.username,email:$scope.email}}).then(function(response){"user password recovered"==response.data?$scope.passwordReset=!0:$scope.userNotFound=!0})}}]);var utilitiesController=angular.module("utilitiesController",[]);utilitiesController.controller("statsController",["$scope","$http",function($scope,$http){$http.get("/utilities/getAllLocations").then(function(payload){$scope.locations=payload.data},function(errPayload){console.log("failure communicating w sigilService API: "+errPayload)})}]);var Basecamp=angular.module("Basecamp",[]);Basecamp.factory("Basecamp",["$http",function($http){var Basecamp=function(id){this.id=id,this.properties=null};return Basecamp.prototype.getBasecampSimple=function(){var self=this;return $http({method:"GET",url:"game/basecamp/"+this.id}).then(function(response){return self.properties=response.data,response},function(response){return self.properties=response.data||"Request failed",response})},Basecamp}]);var Sigil=angular.module("Sigil",[]);Sigil.factory("Sigil",["$http",function($http){function Sigil(name){this.name=name,this.properties=null}return Sigil.prototype.getSigilsByUser=function(){var self=this;return $http.get("game/userSigils/"+this.name).then(function(response){return self.properties=response.data,response},function(response){return self.properties=response.data||"Request failed",response})},Sigil.prototype.getSigilsSimple=function(){return $http.get("game/sigils")},Sigil}]);var navigationController=angular.module("navigationController",[]);navigationController.controller("navigationController",["$scope","$http",function($scope,$http){}]),shamanicWebApp.directive("appearButton",function(){return{restrict:"E",scope:{type:"@"},template:'<span ng-show="showThisButton" ng-class="appearButtonClass" ng-click="saveLocation()"><a>{{message}}</a></span>',controller:function($scope,$http){$scope.message="Appear (check in)",$scope.saveLocation=function(){$http({method:"POST",url:"/user/saveLocation",data:{lat:window.latitude,"long":window.longitude,elevation:window.elevation}}).then(function(response){"saved"==response.data&&($scope.message="Location Saved")},function(response){$scope.message="Location could not be saved"})},$scope.showThisButton=!1,$http({method:"GET",url:"/user/isLoggedIn"}).then(function(response){"true"==response.data&&($scope.showThisButton=!0)},function(response){})},link:function(scope,element,attributes){"button"==scope.type&&(scope.appearButtonClass="appear-button")}}}),shamanicWebApp.directive("basecampButton",function(){return{restrict:"E",scope:{type:"@"},template:'<span ng-show="showThisButton" ng-class="basecampButtonClass" ng-click="assignBasecamp()"><a>{{message}}</a></span>',controller:function($scope,$http){$scope.showThisButton=!0,null===$scope.basecampObj||void 0===$scope.basecampObj?$scope.message="you haven't assigned a basecamp yet. Do so now?":$scope.message="Change Basecamp",$scope.assignBasecamp=function(){console.log("http POSTing to assignNewBasecamp")}},link:function(scope,element,attributes){"button"==scope.type&&(scope.basecampButtonClass="basecamp-button")}}}),shamanicWebApp.directive("d3Map",["gameAssetService",function(gameAssetService){return{restrict:"E",template:'<div class="d3map"></div>',scope:{data:"=",zoomEnabled:"=d3Map"},link:function(scope,element,attributes){function redraw(){var tx=t[0]*d3.event.scale+d3.event.translate[0],ty=t[1]*d3.event.scale+d3.event.translate[1];projection.translate([tx,ty]),projection.scale(s*d3.event.scale),uk.selectAll("path").attr("d",path)}var width=document.body.clientWidth-160,height=document.body.clientHeight-160,svg=d3.select("d3-map").append("svg").attr("width",width).attr("height",height);svg.call(d3.behavior.zoom().on("zoom",redraw)),scope.zoomEnabled&&(console.log("zoomEnabled..."),svg.call(d3.behavior.zoom().on("zoom",redraw))),svg.append("rect").attr("fill",function(d){}),d3.selectAll("svg").attr("id","gradient");var uk=svg.append("svg:g").attr("id","uk"),projection=d3.geo.albers().center([-5,55.4]).rotate([4.4,0]).parallels([50,60]).scale(6e3).translate([width/2,height/2]),path=d3.geo.path().projection(projection),t=projection.translate(),s=projection.scale(),subunits={},promise=gameAssetService.getMapSimple();promise.then(function(payload){scope.ukTopology=payload.data,subunits=topojson.feature(scope.ukTopology,scope.ukTopology.objects.subunits),uk.append("path").datum(subunits).attr("d",path)},function(errPayload){console.log("failure communicating w gameAssetService.getMap API: "+errPayload)})}}}]),shamanicWebApp.directive("grid",function(){return{replace:!0,restrict:"E",template:"<canvas id='xyCanvas'></canvas>",scope:{width:"@",height:"@"},link:function(scope,element,attributes){function draw(mouseX,mouseY){var xCoord=mouseX-canvas.getBoundingClientRect().left,yCoord=mouseY-canvas.getBoundingClientRect().top;ctx.beginPath(),ctx.strokeStyle="black",ctx.lineWidth=.1,ctx.moveTo(xCoord,0),ctx.lineTo(xCoord,canvas.height),ctx.stroke(),ctx.closePath(),cty.beginPath(),cty.strokeStyle="black",cty.lineWidth=.1,cty.moveTo(0,yCoord),cty.lineTo(canvas.width,yCoord),cty.stroke(),cty.closePath()}function drawBackground(){ctx.clearRect(0,0,canvas.width,canvas.height)}d3.selectAll("canvas").attr("width",600).attr("height",800);var canvas=document.getElementById("xyCanvas"),ctx=canvas.getContext("2d"),cty=canvas.getContext("2d");element.bind("mousemove",function(event){drawBackground(),draw(event.x,event.y)})}}}),shamanicWebApp.directive("locationTracker",function(){return{restrict:"E",controller:function($scope,$http){$scope.savePosition=function(position){window.latitude=position.coords.latitude,window.longitude=position.coords.longitude,$http({method:"GET",url:"/user/getAltitude?lat="+window.latitude+"&long="+window.longitude}).then(function(response){window.elevation=response.data},function(response){})},navigator.geolocation&&navigator.geolocation.getCurrentPosition($scope.savePosition)},link:function(scope,element,attributes){}}}),shamanicWebApp.directive("scroll",function($window){return function(scope,element,attrs){angular.element($window).bind("scroll",function(){this.pageYOffset>=100?element.addClass("scrolled"):element.removeClass("scrolled")})}});var scripts=document.getElementsByTagName("script"),currentScriptPath=scripts[scripts.length-1].src;shamanicWebApp.directive("sigilGallery",function($interval,$window){return{restrict:"E",templateUrl:"ui/js/views/sigilPartial.html",scope:{images:"="},link:function(scope,element,attributes){scope.nowShowing=0,$interval(function(){scope.nowShowing!=scope.images.length-1?scope.nowShowing++:scope.nowShowing=0},2e3),scope.openSigilPage=function(index){$window.open(scope.images[index].url)}}}}),shamanicWebApp.directive("zoom",function($interval,$window){return{restrict:"E",template:'<button id="zoomButton" ng-class="zoomButtonClass" ng-click="zoomEnabled = !zoomEnabled; console.log("clicked the zoom button");/>',scope:{type:"@",zoomEnabled:"=zoom"},link:function(scope,element,attributes){function redraw(){var tx=t[0]*d3.event.scale+d3.event.translate[0],ty=t[1]*d3.event.scale+d3.event.translate[1];projection.translate([tx,ty]),projection.scale(s*d3.event.scale),uk.selectAll("path").attr("d",path)}scope.zoomEnabled&&(console.log("zoomEnabled!"),d3.select("svg").call(d3.behavior.zoom().on("zoom",redraw))),"button"==scope.type&&(scope.zoomButtonClass="zoom-button")}}});var gameAssetService=angular.module("gameAssetService",[]);gameAssetService.factory("gameAssetService",["$http",function($http){var basecamp_icon=window.fullname;return{getMapSimple:function(){return $http.get("https://bost.ocks.org/mike/map/uk.json")},getMapRobust:function(){},getSigilsSimple:function(){return $http.get("game/sigils")},getSigilsRobust:function(){},getBasecampLocation:function(){return console.log("inside getBasecamp location: "+basecamp_icon),$http.get("game/basecamp/"+basecamp_icon)}}}]);var terraService=angular.module("terraService",[]);terraService.factory("terraService",["$window","$timeout",function($window,$timeout){var width,height,cyclic={};$timeout(function(){width=d3.select("svg#gradient").attr("width"),height=d3.select("svg#gradient").attr("height"),cyclic=new terra.Terrarium(width/10,height/10,{id:"terraCycle",cellSize:width/100,insertAfter:document.getElementById("stuffFromDavid"),periodic:!0}),cyclic.grid=cyclic.makeGrid("cyclic"),cyclic.animate()},5e3);var cycles=[];return cycles.push(cyclic),function(){terra.registerCA({type:"cyclic",colors:["255,0,0,0.1","255,96,0,1","255,191,0,0.2","223,255,0,1","128,255,0,0.3","32,255,0,1","0,255,64,0.4","0,255,159,1","0,255,255,0.5","0,159,255,1","0,64,255,0.6","32,0,255,1","127,0,255,0.7","223,0,255,1","255,0,191,0.8","255,0,96,1"],colorFn:function(){return this.colors[this.state]},process:function(neighbors,x,y){var next=(this.state+1)%16,changing=neighbors.some(function(spot){return spot.creature.state===next});return changing&&(this.state=next),!0}},function(){this.state=Math.floor(16*Math.random())})}}]);