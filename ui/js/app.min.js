/*! Shamanic.io 2016-02-07 */
var shamanicWebApp=angular.module("shamanicWebApp",["mm.foundation","indexController","userControllers","gameController","menuControllers","utilitiesController","navigationController","ngRoute"]);shamanicWebApp.config(["$routeProvider","$httpProvider",function($routeProvider,$httpProvider){$httpProvider.defaults.headers.post["Content-Type"]="application/x-www-form-urlencoded",$httpProvider.defaults.transformRequest.unshift(function(data,headersGetter){var key,result=[];for(key in data)data.hasOwnProperty(key)&&("undefined"==typeof data[key]&&(data[key]=""),result.push(encodeURIComponent(key)+"="+encodeURIComponent(data[key])));return result.join("&")}),$routeProvider.when("/game/basecamp/:basecamp_icon",{templateUrl:"ui/js/views/basecamp.html",controller:"gameController"}).otherwise({redirectTo:"/"})}]);var gameController=angular.module("gameController",["sigilService","terraService"]);gameController.controller("gameController",["$scope","$routeParams","sigilService","terraService",function($scope,$routeParams,sigilService,terraService){$scope.terrafy=function(){terraService()},$scope.sigilList=[];var promise=sigilService.getSigilsSimple();promise.then(function(payload){$scope.restImageList=payload.data,console.log("from inside getSigilsSimple promise: "+JSON.stringify(payload.data))},function(errPayload){console.log("failure communicating w sigilService API: "+errPayload)}),$scope.imageList=[{url:"http://placekitten.com/201/201",name:"sigilOne"},{url:"http://placekitten.com/201/203",name:"sigilTwo"}],$scope.basecamp_icon=$routeParams.basecamp_icon,console.log("basecamp_icon: "+$scope.basecamp_icon)}]);var indexController=angular.module("indexController",[]);indexController.controller("indexController",["$scope","$http",function($scope,$http){}]);var menuControllers=angular.module("menuControllers",[]);menuControllers.controller("menuController",["$scope","$http",function($scope,$http){}]);var userControllers=angular.module("userControllers",[]);userControllers.controller("loginController",["$scope","$http",function($scope,$http){$scope.showValidationMessages=!1,$scope.userNotFound=!1,$scope.submit=function(isFormValid){$scope.showValidationMessages=!0,isFormValid&&$http({url:"/user/checkLogin",method:"POST",data:{username:$scope.username,password:$scope.password}}).then(function(response){return $scope.userNotFound=!1,"user login sucessful"!=response.data?void($scope.userNotFound=!0):void(window.location="/user/account")},function(response){isFormValid=!1})}}]),userControllers.controller("signupController",["$scope","$http",function($scope,$http){$scope.showValidationMessages=!1,$scope.passwordMatch=!0,$scope.submit=function(isFormValid){if($scope.showValidationMessages=!0,$scope.passwordMatch=!0,$scope.password!=$scope.confirm&&($scope.passwordMatch=!1,isFormValid=!1),isFormValid){$scope.showEmailTakenError=!1,$scope.showUserTakenError=!1;var values={email:$scope.email,username:$scope.username};angular.forEach(values,function(value,key){$http({url:"/user/checkExistingValue",method:"POST",data:{property:key,value:value}}).then(function(response){"value exists"==response.data&&("email"==key?$scope.showEmailTakenError=!0:$scope.showUserTakenError=!0,isFormValid=!1),"username"==key&&isFormValid&&document.forms.signupform.submit()},function(response){isFormValid=!1})})}}}]),userControllers.controller("userAccountController",["$scope","$http",function($scope,$http){$scope.showAccountForm=!1,$scope.showValidationMessages=!1,$scope.fullname=window.fullname,$scope.showUpdateMessage=!1,$scope.updateMessage="",$scope.submit=function(isFormValid){$scope.showValidationMessages=!0,$scope.passwordMatch=!0,$scope.password!=$scope.confirm&&($scope.passwordMatch=!1,isFormValid=!1),isFormValid&&($scope.showUpdateMessage=!1,$scope.updateMessage="",$http({url:"/user/update",method:"POST",data:{fullname:$scope.fullname,password:$scope.password}}).then(function(response){$scope.showUpdateMessage=!0,$scope.updateMessage=response.data,$scope.showAccountForm=!1}))}}]),userControllers.controller("forgotController",["$scope","$http",function($scope,$http){$scope.showValidationMessages=!1,$scope.userNotFound=!1,$scope.passwordReset=!1,$scope.submit=function(isFormValid){$scope.showValidationMessages=!0,$scope.userNotFound=!1,"undefined"!=typeof $scope.username&&""!=$scope.username||"undefined"!=typeof $scope.email&&""!=$scope.email||($scope.userNotFound=!0,isFormValid=!1),isFormValid&&$http({url:"/user/checkForgot",method:"POST",data:{username:$scope.username,email:$scope.email}}).then(function(response){"user password recovered"==response.data?$scope.passwordReset=!0:$scope.userNotFound=!0})}}]);var utilitiesController=angular.module("utilitiesController",[]);utilitiesController.controller("statsController",["$scope","$http",function($scope,$http){var promise=$http.get("/utilities/getAllLocations");promise.then(function(payload){$scope.locations=payload.data},function(errPayload){console.log("failure communicating w sigilService API: "+errPayload)})}]);var navigationController=angular.module("navigationController",[]);navigationController.controller("navigationController",["$scope","$http",function($scope,$http){}]),shamanicWebApp.directive("appearButton",function(){return{restrict:"E",scope:{type:"@"},template:'<span ng-show="showThisButton" ng-class="appearButtonClass" ng-click="saveLocation()"><a>{{message}}</a></span>',controller:function($scope,$http){$scope.message="Appear (check in)",$scope.saveLocation=function(){$http({method:"POST",url:"/user/saveLocation",data:{lat:window.latitude,"long":window.latitude,elevation:window.elevation}}).then(function(response){"saved"==response.data&&($scope.message="Location Saved")},function(response){$scope.message="Location could not be saved"})},$scope.showThisButton=!1,$http({method:"GET",url:"/user/isLoggedIn"}).then(function(response){"true"==response.data&&($scope.showThisButton=!0)},function(response){})},link:function(scope,element,attributes){"button"==scope.type&&(scope.appearButtonClass="appear-button")}}}),shamanicWebApp.directive("d3Map",["$timeout","sigilService",function($timeout,sigilService){return{restrict:"E",templateUrl:"ui/js/views/mapPartial.html",scope:{data:"="},link:function(scope,element,attributes){function redraw(){var tx=t[0]*d3.event.scale+d3.event.translate[0],ty=t[1]*d3.event.scale+d3.event.translate[1];projection.translate([tx,ty]),projection.scale(s*d3.event.scale),uk.selectAll("path").attr("d",path)}function bgColors(){function updateGradient(){if(void 0!==$){var c0_0=colors[colorIndices[0]],c0_1=colors[colorIndices[1]],c1_0=colors[colorIndices[2]],c1_1=colors[colorIndices[3]],istep=1-step,r1=Math.round(istep*c0_0[0]+step*c0_1[0]),g1=Math.round(istep*c0_0[1]+step*c0_1[1]),b1=Math.round(istep*c0_0[2]+step*c0_1[2]),color1="rgb("+r1+","+g1+","+b1+")",r2=Math.round(istep*c1_0[0]+step*c1_1[0]),g2=Math.round(istep*c1_0[1]+step*c1_1[1]),b2=Math.round(istep*c1_0[2]+step*c1_1[2]),color2="rgb("+r2+","+g2+","+b2+")";$("#gradient").css({background:"-webkit-gradient(linear, left top, right top, from("+color1+"), to("+color2+"))"}).css({background:"-moz-linear-gradient(left, "+color1+" 0%, "+color2+" 100%)"}),step+=gradientSpeed,step>=1&&(step%=1,colorIndices[0]=colorIndices[1],colorIndices[2]=colorIndices[3],colorIndices[1]=(colorIndices[1]+Math.floor(1+Math.random()*(colors.length-1)))%colors.length,colorIndices[3]=(colorIndices[3]+Math.floor(1+Math.random()*(colors.length-1)))%colors.length)}}var colors=new Array([62,35,255],[60,255,60],[255,35,98],[45,175,230],[255,0,255],[255,128,0]),step=0,colorIndices=[0,1,2,3],gradientSpeed=.002;setInterval(updateGradient,10)}var width=600,height=800,svg=d3.select(".main-container").append("svg").attr("width",width).attr("height",height).call(d3.behavior.zoom().on("zoom",redraw));svg.append("rect").attr("fill",function(d){return bgColors()}),d3.selectAll("svg").attr("id","gradient");var uk=svg.append("svg:g").attr("id","uk"),projection=d3.geo.albers().center([-5,55.4]).rotate([4.4,0]).parallels([50,60]).scale(6e3).translate([width/2,height/2]),path=d3.geo.path().projection(projection),t=projection.translate(),s=projection.scale(),subunits={},promise=sigilService.getMapSimple();promise.then(function(payload){scope.ukTopology=payload.data,subunits=topojson.feature(scope.ukTopology,scope.ukTopology.objects.subunits),uk.append("path").datum(subunits).attr("d",path)},function(errPayload){console.log("failure communicating w sigilService.getMap API: "+errPayload)});var topology={type:"Topology",transform:{scale:[1,1],translate:[0,0]},objects:{foo:{type:"Polygon",arcs:[[0]]},bar:{type:"Polygon",arcs:[[0,1]]}},arcs:[[[0,0],[1,1]],[[1,1],[-1,-1]]]};topojson.feature(topology,topology.objects.foo);svg.append("circle").attr("cx",30).attr("cy",80).attr("r",20)}}}]),shamanicWebApp.directive("locationTracker",function(){return{restrict:"E",controller:function($scope,$http){$scope.savePosition=function(position){window.latitude=position.coords.latitude,window.longitude=position.coords.longitude,$http({method:"GET",url:"/user/getAltitude?lat="+window.latitude+"&long="+window.longitude}).then(function(response){window.elevation=response.data},function(response){})},navigator.geolocation&&navigator.geolocation.getCurrentPosition($scope.savePosition)},link:function(scope,element,attributes){}}}),shamanicWebApp.directive("scroll",function($window){return function(scope,element,attrs){angular.element($window).bind("scroll",function(){this.pageYOffset>=100?element.addClass("scrolled"):element.removeClass("scrolled")})}});var scripts=document.getElementsByTagName("script"),currentScriptPath=scripts[scripts.length-1].src;shamanicWebApp.directive("sigilGallery",function($interval,$window){return{restrict:"E",templateUrl:"ui/js/views/sigilPartial.html",scope:{images:"="},link:function(scope,element,attributes){scope.nowShowing=0,$interval(function(){scope.nowShowing!=scope.images.length-1?scope.nowShowing++:scope.nowShowing=0},2e3),scope.openSigilPage=function(index){$window.open(scope.images[index].url)}}}});var sigilService=angular.module("sigilService",[]);sigilService.factory("sigilService",["$http",function($http){var basecamp_icon=window.fullname;return{getMapSimple:function(){return $http.get("http://bost.ocks.org/mike/map/uk.json")},getMapRobust:function(){},getSigilsSimple:function(){return $http.get("game/sigils")},getSigilsRobust:function(){},getBasecampLocation:function(){return $http.get("game/basecamp/"+basecamp_icon)}}}]);var terraService=angular.module("terraService",[]);terraService.factory("terraService",["$window","$timeout",function(win,$timeout){var width,height,cyclic={};$timeout(function(){width=$("svg#gradient").width(),height=$("svg#gradient").height(),cyclic=new terra.Terrarium(width/10,height/10,{id:"terraCycle",cellSize:width/100,insertAfter:document.getElementById("stuffFromDavid"),periodic:!0}),cyclic.grid=cyclic.makeGrid("cyclic"),cyclic.animate()},5e3);var cycles=[];return cycles.push(cyclic),function(){terra.registerCA({type:"cyclic",colors:["255,0,0,0.1","255,96,0,1","255,191,0,0.2","223,255,0,1","128,255,0,0.3","32,255,0,1","0,255,64,0.4","0,255,159,1","0,255,255,0.5","0,159,255,1","0,64,255,0.6","32,0,255,1","127,0,255,0.7","223,0,255,1","255,0,191,0.8","255,0,96,1"],colorFn:function(){return this.colors[this.state]},process:function(neighbors,x,y){var next=(this.state+1)%16,changing=neighbors.some(function(spot){return spot.creature.state===next});return changing&&(this.state=next),!0}},function(){this.state=Math.floor(16*Math.random())})}}]);